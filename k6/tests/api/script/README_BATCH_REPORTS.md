# 批量报表查询系统

## 功能特性

1. **一键启动多报表查询** - 自动按优先级顺序查询多个报表
2. **实时进度显示** - 控制台动态显示查询进度条和状态
3. **性能监控** - 记录每个报表的查询耗时、数据量
4. **数据汇总** - 自动汇总所有报表数据
5. **对比分析** - 自动对比多个报表的数据差异
6. **多格式报告** - 生成 HTML、JSON 格式的详细报告

## 使用方法

### 快速开始

```bash
# 运行批量报表查询
k6 run k6/tests/api/script/batchReportsV2.js
```

### 添加新报表

编辑 `k6/config/reports.js` 文件，添加新报表配置：

```javascript
{
    name: '新报表名称',
    tag: 'unique_report_tag',
    importPath: '../path/to/report.js',
    functionName: 'exportedFunctionName',
    priority: 1,
    description: '报表描述'
}
```

然后在 `batchReports.js` 的 `executeReport` 函数中添加对应处理逻辑：

```javascript
case 'unique_report_tag':
    result = importedFunction(data);
    break;
```

### 报表输出示例

```
╔═══════════════════════════════════════════════════════════╗
║          批量报表查询系统 - 初始化                         ║
╚═══════════════════════════════════════════════════════════╝

[1/2] 正在获取登录Token...
[1/2] ✓ Token获取成功

╔═══════════════════════════════════════════════════════════╗
║          批量报表查询系统 - 开始执行                         ║
╠═══════════════════════════════════════════════════════════╣
║  计划查询报表数: 6                                          ║
║  执行方式: 串行查询（按优先级排序）                          ║
╚═══════════════════════════════════════════════════════════╝

[1/6] [███░░░░░░░░░░░░░░░░░░] 下级账号报表
────────────────────────────────────────────────────────────
  ✓ 状态: 成功
  ⏱ 耗时: 1254ms
  📦 数据量: 15.32 KB
  📊 记录数: 48

[2/6] [█████░░░░░░░░░░░░░░░░] 返佣等级报表
────────────────────────────────────────────────────────────
  ✓ 状态: 成功
  ⏱ 耗时: 456ms
  📦 数据量: 2.15 KB
  📊 记录数: 6

... (更多报表查询)

╔═══════════════════════════════════════════════════════════╗
║          批量报表查询系统 - 执行完成                         ║
╠═══════════════════════════════════════════════════════════╣
║  总报表数: 6                                                ║
║  成功: 5                                                    ║
║  失败: 1                                                    ║
║  成功率: 83.33%                                             ║
╚═══════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════╗
║                    查询汇总统计                               ║
╠═══════════════════════════════════════════════════════════╣
║  总耗时: 3.45s                                             ║
║  平均耗时: 575.00ms                                        ║
║  最快: 456ms                                               ║
║  最慢: 1254ms                                              ║
║  总数据量: 45.67 KB                                        ║
╚═══════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════╗
║                    数据对比分析                               ║
╠═══════════════════════════════════════════════════════════╣
║  下级账号报表      vs 返佣等级报表                          ║
║    记录数: 48       vs 6             ║
║    差值: 42        (700.00%)                           ║
║    ──────────────────────────────────────────────────────║
║  下级账号报表      vs 充值订单报表                          ║
║    记录数: 48       vs 8             ║
║    差值: 40        (500.00%)                           ║
╚═══════════════════════════════════════════════════════════╝
```

## 配置说明

### 报表优先级

报表按照 `priority` 字段从小到大排序执行，数字越小越先执行。

### 自定义指标

脚本提供以下自定义指标：

- `report_duration`: 各报表查询耗时（带标签）
- `report_success`: 报表查询成功率
- `report_count`: 报表查询总数
- `report_data_size`: 报表数据量

### 阈值配置

在 `options.thresholds` 中配置：

```javascript
thresholds: {
    'report_duration': ['avg<3000'],  // 平均耗时小于3秒
    'report_success': ['rate>0.95'],  // 成功率大于95%
    'http_req_duration': ['p(95)<5000'] // 95%请求小于5秒
}
```

## 报告文件

测试运行后会生成以下文件：

1. **HTML报告**: `reports/batch-reports-<timestamp>.html`
   - 交互式图表
   - 详细性能数据
   - 响应时间分布

2. **JSON摘要**: `reports/batch-reports-<timestamp>-summary.json`
   - 所有报表原始数据
   - 汇总统计信息
   - 对比分析结果

## 高级用法

### 选择性查询

创建自定义查询脚本，仅查询特定报表：

```javascript
import { getReportsByCategory } from '../../../config/reports.js';

const financeReports = getReportsByCategory('finance');
```

### 并行查询（高级）

修改 `executeReport` 循环，使用 K6 的场景配置实现并行查询：

```javascript
export const options = {
  scenarios: {
    report1: { executor: 'per-vu-iterations', vus: 1, iterations: 1, exec: 'report1' },
    report2: {
      executor: 'per-vu-iterations',
      vus: 1,
      iterations: 1,
      startTime: '1s',
      exec: 'report2'
    }
  }
};
```

### 数据持久化

将 JSON 摘要数据导入数据库或 BI 工具进行长期分析。

## 故障排查

### Token获取失败

检查 `AdminLogin()` 函数和 `ENV_CONFIG` 配置。

### 某个报表查询失败

查看控制台错误信息，检查：

1. API路径是否正确
2. 数据格式是否符合预期
3. 网络连接是否正常

### 数据对比无结果

确保至少有2个以上报表查询成功并返回有效数据。
