# 批量活动创建系统

## 功能特性

1. **✅ 一键启动** - 运行单个脚本创建所有活动
2. **✅ 实时进度** - 进度条、状态图标、耗时统计
3. **✅ 数据汇总** - 自动计算成功率、总耗时、平均耗时
4. **✅ 对比分析** - 多活动创建耗时对比
5. **✅ 多格式报告** - HTML + JSON
6. **✅ 性能监控** - 自定义指标记录每个活动创建性能

## 使用方法

### 快速开始

```bash
# 运行批量活动创建
k6 run k6/tests/api/script/batchActivities.js
```

### 添加新活动

编辑 `k6/config/activities.js` 文件，添加新活动配置：

```javascript
{
    name: '新活动名称',
    tag: 'unique_activity_tag',
    func: createNewActivity,
    priority: 1,
    description: '活动描述',
    category: 'promotion' // 分类：promotion, finance, daily, game, system
}
```

然后在文件中添加对应的创建函数：

```javascript
function createNewActivity(data) {
  // 实现活动创建逻辑
  return {
    activityId: 'NEW_' + Date.now(),
    name: '新活动_' + Date.now(),
    type: 'new',
    status: 'created',
    createTime: new Date().toISOString()
  };
}
```

### 活动输出示例

```
╔═══════════════════════════════════════════════════════════╗
║          批量活动创建系统 - 初始化                         ║
╚═══════════════════════════════════════════════════════════╝

[1/2] 正在获取登录Token...
[1/2] ✓ Token获取成功

╔═══════════════════════════════════════════════════════════╗
║          批量活动创建系统 - 开始执行                         ║
╠═══════════════════════════════════════════════════════════╣
║  计划创建活动数: 5                                          ║
║  执行方式: 串行创建（按优先级排序）                          ║
╚═══════════════════════════════════════════════════════════╝

[1/5] [█████░░░░░░░░░░░░░░░] 优惠券活动
────────────────────────────────────────────────────────────
  ✓ 状态: 创建成功
  ⏱ 耗时: 1254ms
  📦 数据量: 2.15 KB
  🆔 活动ID: COUPON_1642912345678
  📊 活动类型: coupon

[2/5] [█████████░░░░░░░░░░░] 系统活动
────────────────────────────────────────────────────────────
  ✓ 状态: 创建成功
  ⏱ 耗时: 456ms
  📦 数据量: 1.32 KB
  🆔 活动ID: SYS_1642912345678
  📊 活动类型: system

... (更多活动创建)

╔═══════════════════════════════════════════════════════════╗
║          批量活动创建系统 - 执行完成                         ║
╠═══════════════════════════════════════════════════════════╣
║  总活动数: 5                                                ║
║  成功: 5                                                    ║
║  失败: 0                                                    ║
║  成功率: 100.00%                                            ║
╚═══════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════╗
║                    创建汇总统计                               ║
╠═══════════════════════════════════════════════════════════╣
║  总耗时: 3.45s                                             ║
║  平均耗时: 690.00ms                                        ║
║  最快: 456ms                                               ║
║  最慢: 1254ms                                              ║
║  总数据量: 12.67 KB                                        ║
╚═══════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════╗
║                    活动对比分析                               ║
╠═══════════════════════════════════════════════════════════╣
║  优惠券活动        vs 系统活动                              ║
║    耗时: 1254ms    vs 456ms         ║
║    差值: 798ms     (175.00%)                           ║
║    类型: coupon    vs system        ║
║    ──────────────────────────────────────────────────────║
║  优惠券活动        vs 充值活动                              ║
║    耗时: 1254ms    vs 678ms         ║
║    差值: 576ms     (85.00%)                            ║
╚═══════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════╗
║                    活动详情展示                               ║
╠═══════════════════════════════════════════════════════════╣
║  🎯 优惠券活动                                              ║
║     ID: COUPON_1642912345678                              ║
║     类型: coupon                                          ║
║     状态: created                                         ║
║     创建时间: 2026-01-22T10:30:45.123Z                    ║
║     优惠券数量: 100                                        ║
║    ──────────────────────────────────────────────────────║
║  🎯 系统活动                                                ║
║     ID: SYS_1642912345678                                 ║
║     类型: system                                          ║
║     状态: created                                         ║
║     创建时间: 2026-01-22T10:30:45.678Z                    ║
║    ──────────────────────────────────────────────────────║
╚═══════════════════════════════════════════════════════════╝
```

## 配置说明

### 活动优先级

活动按照 `priority` 字段从小到大排序创建，数字越小越先创建。

### 活动分类

支持以下活动分类：

- `promotion` - 促销活动（优惠券、系统活动）
- `finance` - 财务活动（充值活动）
- `daily` - 日常活动（签到活动）
- `game` - 游戏活动（抽奖活动）
- `system` - 系统活动

### 自定义指标

脚本提供以下自定义指标：

- `activity_duration`: 各活动创建耗时（带标签）
- `activity_success`: 活动创建成功率
- `activity_count`: 活动创建总数
- `activity_data_size`: 活动数据量

### 阈值配置

在 `options.thresholds` 中配置：

```javascript
thresholds: {
    'activity_duration': ['avg<3000'],  // 平均耗时小于3秒
    'activity_success': ['rate>0.95'],  // 成功率大于95%
    'http_req_duration': ['p(95)<5000'] // 95%请求小于5秒
}
```

## 报告文件

测试运行后会生成以下文件：

1. **HTML报告**: `reports/batch-activities-<timestamp>.html`
   - 交互式图表
   - 详细性能数据
   - 创建时间分布

2. **JSON摘要**: `reports/batch-activities-<timestamp>-summary.json`
   - 所有活动创建数据
   - 汇总统计信息
   - 对比分析结果

## 高级用法

### 选择性创建

创建自定义创建脚本，仅创建特定分类的活动：

```javascript
import { getActivitiesByCategory } from '../../../config/activities.js';

const promotionActivities = getActivitiesByCategory('promotion');
```

### 并行创建（高级）

修改 `executeActivity` 循环，使用 K6 的场景配置实现并行创建：

```javascript
export const options = {
  scenarios: {
    activity1: { executor: 'per-vu-iterations', vus: 1, iterations: 1, exec: 'activity1' },
    activity2: {
      executor: 'per-vu-iterations',
      vus: 1,
      iterations: 1,
      startTime: '1s',
      exec: 'activity2'
    }
  }
};
```

### 数据持久化

将 JSON 摘要数据导入数据库或 BI 工具进行长期分析。

## 故障排查

### Token获取失败

检查 `AdminLogin()` 函数和 `ENV_CONFIG` 配置。

### 某个活动创建失败

查看控制台错误信息，检查：

1. API路径是否正确
2. 活动数据格式是否符合预期
3. 网络连接是否正常

### 对比分析无结果

确保至少有2个以上活动创建成功并返回有效数据。

## 扩展建议

1. **活动模板** - 创建活动模板库，支持快速复制
2. **批量导入** - 支持从CSV/JSON文件批量导入活动配置
3. **定时创建** - 集成定时任务，支持定时批量创建活动
4. **活动管理** - 添加活动查询、修改、删除功能
5. **通知集成** - 创建完成后发送通知（邮件、钉钉、企业微信等）
